name: Publish to PyPI (Tag Release)

on:
  push:
    tags:
      - 'v*'  # Runs when a tag like v1.2.3 is pushed

permissions:
  contents: read

jobs:
  publish:
    name: publish-pypi
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install Poetry
        run: |
          python -m pip install --upgrade pip
          pip install poetry

      - name: Configure Poetry
        run: poetry config virtualenvs.create false

      # --- Set version from Git tag ---
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Detected version: $VERSION"

      - name: Set Poetry version
        run: |
          poetry version ${{ steps.version.outputs.version }}

      # --- Optional: Update version in C++ / build files ---
      - name: Update version in source files
        run: |
          VERSION=${{ steps.version.outputs.version }}
          echo "Updating version strings in source files..."
          # Example: adjust the regex below for your project
          find . -type f \( -name "src/*.cpp" -o -name "src/*.h" -o -name "*.py" -o -name "meson.build" \) \
            -exec sed -i -E "s/[0-9]+\.[0-9]+\.[0-9]+/${VERSION}/g" {} +

      # --- Build & Publish to PyPI ---
      - name: Build package
        run: poetry build

      - name: Publish to PyPI
        env:
          POETRY_PYPI_TOKEN_PYPI: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          poetry publish --no-interaction --username __token__ --password $POETRY_PYPI_TOKEN_PYPI
